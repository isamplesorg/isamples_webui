<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>    
    <!--
    Interactive evaluate of query
    -->
    <style>
        @import url("https://fonts.googleapis.com/css?family=Roboto+Condensed:200,500");
        @import url("https://fonts.googleapis.com/css?family=Roboto+Mono:200,300,400");
        body {
            font-family: "Roboto Mono", sans-serif;
            font-weight: 300;
            color: #555555;
            font-size: 14px;
        }
        em {
            background: #ffffb8;
            font-style: normal;
        }
        .spacer {
            width: 1rem;
            display: inline-block;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        td {
            padding-top:0.5rem;
            padding-bottom: 0.5rem;
            word-break: break-word;
        }
        tbody {
            max-height: 70vh;
            width: 100%;
            overflow: auto;
            display: block;
        }
        thead, tr {
            display: block;
        }
    </style>
    <script type="module">
        import { ISamplesAPI } from '../js/isamples-api.js';
        import { ISamplesState } from '../js/isamples-state.js';
        import { EventLogger } from '../js/wc-logger.js';
        import { EventBus } from '../js/eventbus.js';
        import { html, render, unsafeHTML } from '../js/isamples-ui-imports.js';

        const options = {
            // Default Solr query
            defaultQuery: '*:*',
            // Name of the global API instance
            APIName: "iSamplesAPI",
            // Name of the global event bus
            eventBusName: "iSamplesEventBus",
            // Address of the iSamples API service
            serviceEndpoint: "http://localhost:8000/",

            // Configuration for the records view
            records: {
                elementId: "records-view",
                // Height of the table div
                tableHeight: '25rem',
                // Number of records to retrieve in a page
                pageSize: 100,
                // Columns to show in the table
                columns: [
                    {title:"ID", field:"id"},
                    {title:"Source", field:"source"},
                    {title:"Label", field:"label"},
                    {title:"TEXT", field:"searchText"},
                ],
            }
        };        

        // Create the Event Bus instance before anything else
        globalThis[ options.eventBusName ] = new EventBus();

        // Create the API instance for accessing data
        const API = new ISamplesAPI(options);
        globalThis[ options.APIName ] = API;

        function humanize(x, n) {
           return x.toFixed(n);
        }

        function hlText(txt) {
            const res = [];
            txt.forEach((e) => {
                res.push(html`<span>${unsafeHTML(e)}</span><span class="spacer">&nbsp;</span>`);
            })
            return res;
        }

        /**
         * Handle query changes by loading results
         */
        async function loadRecords(q) {
            console.log("Loading query = ",q);
            let params = {
                q: q,
                rows: 50,
                hl: "on",
                "hl.fl": "searchText",
                "hl.tag.pre": "<em>",
                "hl.tag.post": "</em>",
                "hl.encoder": "html",
                "hl.usePhraseHighlighter": "true",
                "hl.highlightMultiTerm": "true",
                "hl.preserveMulti": "true",
                "fields":["id", "score", "source", "label", "searchText"],
            }
            API.select(params)
            .then((data) => {
                if (data["error"] !== undefined) {
                    globalThis.iSamplesEventBus.emit(
                        "status",
                        null,
                        {"source":"solr", level:"error", msg:[data.error, ]}
                    );
                    document.getElementById("record_count").innerText = "Error!";
                    render(html``, document.getElementById("results"));
                    return;
                }
                document.getElementById("record_count").innerText = data.response.numFound;
                let dest = document.getElementById("results");
                const rows = [];
                console.log(data.response);
                data.response.docs.forEach((doc) => {
                    rows.push(html`<tr>
                            <td style="width:10rem">${doc.id}</td>
                            <td style="width:5rem">${humanize(doc.score, 3)}</td>
                            <td>${hlText(data.highlighting[doc.id].searchText)}</td>
                        </tr>`);
                });

                render(html`<thead><tr><th>ID</th><th>Score</th><th>Text</th></tr></thead>
                <tbody>${rows}</tbody>`, dest);
            })
        }

        globalThis.iSamplesEventBus.on(
            "query_state_changed",
            (data) => {
                document.getElementById("record_count").innerText = "loading...";
                loadRecords(data.q);
            });

        // map console messages to the EventLogger
        function subscribeTo(eventName) {
            globalThis.iSamplesEventBus.on(
                eventName,
                (data) => {
                    console.log(`Event: ${eventName}:`, data);
                    globalThis.iSamplesEventBus.emit(
                        "status",
                        null,
                        {"source":eventName, level:"info", msg:[data, ]}
                    );
                }
            );
        }
        // Subscribe to events and log them
        subscribeTo("query_state_changed");
        subscribeTo("record_selected");

    </script>
</head>
<body>
    <header>
        <p>Query highlights</p>
        <p>Using the solr highlighter to indicate query term matching. Results are shown only for the 
            <code>searchText</code> even though other fields may be specified in the query.
        </p>
    </header>
    <section>
        <isamples-state eventBusName="iSamplesEventBus"></isamples-state>
        <p>Number of matches:<span id="record_count"></span></p>
        <table id="results">
        </table>
    </section>    
    <footer><hr />
        <wc-logger isOpen title="Event Log" eventBusName="iSamplesEventBus"></wc-logger>
</body>
</html>
