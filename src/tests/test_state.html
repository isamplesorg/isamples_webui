<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>    
    <!--
    Interactive test of isamples-state component
    -->
    <link rel="stylesheet" href="../css/records.css" />
    <style>
    .gutter {
        background-color: #eee;
        background-repeat: no-repeat;
        background-position: 50%;
    }

    .gutter.gutter-horizontal {
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
        cursor: col-resize;
    }

    .gutter.gutter-vertical {
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII=');
        cursor: row-resize;
    }        
    </style>
    <script type="module">
        import { Split } from '../js/isamples-ui-imports.js';
        import { ISamplesAPI } from '../js/isamples-api.js';
        import { ISamplesState } from '../js/isamples-state.js';
        import { RecordsTable } from "../js/records.js";
        import { ISamplesRecord } from '../js/isamples-record.js';
        import { EventLogger } from '../js/wc-logger.js';
        import { EventBus } from '../js/eventbus.js';

        const options = {
            // Default Solr query
            defaultQuery: '*:*',
            // Name of the global API instance
            APIName: "iSamplesAPI",
            // Name of the global event bus
            eventBusName: "iSamplesEventBus",
            // Address of the iSamples API service
            serviceEndpoint: "http://localhost:8000/",

            // Configuration for the records view
            records: {
                elementId: "records-view",
                // Height of the table div
                tableHeight: '25rem',
                // Number of records to retrieve in a page
                pageSize: 100,
                // Columns to show in the table
                columns: [
                    {title:"ID", field:"id"},
                    {title:"Source", field:"source"},
                    {title:"Label", field:"label"},
                    {title:"hasContext...", field:"hasContextCategory"},
                    {title:"hasMaterial...", field:"hasMaterialCategory"},
                    {title:"hasSpecimen...", field:"hasSpecimenCategory"},
                    {title:"Produced", field:"producedBy_resultTime"},
                    {title:"Keywords", field:"keywords"},
                ],
            }
        };        

        // Create the Event Bus instance before anything else
        globalThis[ options.eventBusName ] = new EventBus();

        // Create the API instance for accessing data
        globalThis[ options.APIName ] = new ISamplesAPI(options);

        // create the records view
        let records = new RecordsTable(options);

        // Subscribe "record_selected" to load the clicked record
        // into the record view
        globalThis.iSamplesEventBus.on(
            "record_selected",
            (data) => {
                const rele = document.getElementById("record-view");
                rele.setData(globalThis.iSamplesAPI.thing(data.value, "solr"), "solr");
            }
        );
        // Subscribe "query_state_changed" to clear the current record view
        globalThis.iSamplesEventBus.on(
            "query_state_changed",
            (data) => {
                const rele = document.getElementById("record-view");
                rele.clearRecord();
            }
        );

        // map console messages to the EventLogger
        function subscribeTo(eventName) {
            globalThis.iSamplesEventBus.on(
                eventName,
                (data) => {
                    console.log(`Event: ${eventName}:`, data);
                    globalThis.iSamplesEventBus.emit(
                        "status",
                        null,
                        {"source":eventName, level:"info", msg:[data, ]}
                    );
                }
            );
        }
        // Subscribe to events and log them
        subscribeTo("query_state_changed");
        subscribeTo("record_selected");

        // Add a splitter between the table and the individual record view
        Split(['#records-view', '#record-view'], {
            direction: "horizontal",
            sizes:[75, 25],
        });      
    </script>
</head>
<body>
    <header>
        <p>Query state</p>
        <p>The query-state component keeps track of the current query and filter queries 
            applied to the collection. 
        </p>
    </header>
    <section>
        <isamples-state eventBusName="iSamplesEventBus"></isamples-state>
        <div style="display:flex;flex-direction: row;">
            <div id="records-view"></div>
            <isamples-record id="record-view" eventBusName="iSamplesEventBus"></isamples-record>
        </div>
    </section>    
    <footer><hr />
        <wc-logger isOpen title="Event Log" eventBusName="iSamplesEventBus"></wc-logger>
</body>
</html>
